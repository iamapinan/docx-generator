<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>DOCX Template Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>üöÄ DOCX Template Generator</h1>
                <nav>
                    <a href="/">üè† Home</a>
                    <a href="/about">‚ÑπÔ∏è About</a>
                    <a href="/docs">üìñ Docs</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <h2 class="section-title">üìã Available Templates</h2>
        <div id="templates">
            <div class="empty-state">
                <div class="icon">üìÑ</div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï...</p>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openUploadModal()" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï" id="uploadFab">
        üì§
    </button>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì§ Upload Template</h2>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå DOCX ‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholders ‡πÄ‡∏ä‡πà‡∏ô {name}, {date}, {email}</p>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" name="template" accept=".docx" required class="file-input" />
                    <label class="file-input-label">
                        üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå DOCX Template
                    </label>
                </div>
                <button type="submit" class="upload-btn" id="uploadSubmitBtn">
                    üì§ Upload Template
                </button>
            </form>
            
            <div class="tips">
                <strong>üí° Tips:</strong> <small>‡πÉ‡∏ô template ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà placeholders ‡πÄ‡∏ä‡πà‡∏ô {name}, {companyName} ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ easy-template-x ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ formatting ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
            </div>
        </div>
    </div>

    <script>
        // Modal Management
        function openUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('uploadModal');
            if (event.target === modal) {
                closeUploadModal();
            }
        }

        // Upload Form Handler
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.getElementById('uploadSubmitBtn');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<span class="loading"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    submitBtn.innerHTML = '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                    setTimeout(() => {
                        closeUploadModal();
                        loadTemplates();
                        this.reset();
                        const fileLabel = this.querySelector('.file-input-label');
                        fileLabel.innerHTML = 'üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå DOCX Template';
                        fileLabel.style.color = 'var(--text-light)';
                        fileLabel.style.borderColor = 'var(--border-light)';
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }, 1500);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        async function loadTemplates() {
            try {
                const res = await fetch('/api/templates');
                
                if (res.status === 401) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ login ‡πÉ‡∏´‡∏°‡πà');
                    return;
                }

                const data = await res.json();
                const templatesDiv = document.getElementById('templates');
                
                if (data.templates.length === 0) {
                    templatesDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìù</div>
                            <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</h3>
                            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå DOCX ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        </div>
                    `;
                    return;
                }

                templatesDiv.innerHTML = '';
                data.templates.forEach((template, index) => {
                    const card = createTemplateCard(template);
                    card.style.animationDelay = `${0.6 + (index * 0.1)}s`;
                    templatesDiv.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templates').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÑ‡∏î‡πâ: ${error.message}</p>
                    </div>
                `;
            }
        }

        function createTemplateCard(template) {
            const card = document.createElement('div');
            card.className = 'template-card';

            const fieldsHtml = template.fields
                .map(
                    (field) =>
                        `<div class="field"><strong>${field.name}</strong>${
                            field.required ? ' <span class="required">*</span>' : ''
                        } (${field.type}) - ${field.description}</div>`
                )
                .join('');

            // Create sample data for testing
            const sampleData = {};
            template.fields.forEach((field) => {
                sampleData[field.name] = field.type === 'number' ? 100 : `example_${field.name}`;
            });

            card.innerHTML = `
                <div class="template-header">
                    <h3 class="template-title">üìÑ ${template.name}</h3>
                    <span class="template-badge">template</span>
                </div>
                <p class="template-description">${template.description}</p>
                
                <div class="fields-section">
                    <div class="fields-toggle" onclick="toggleFields(this)">
                        <span>Fields ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (${template.fields.length} fields)</span>
                        <span class="icon">‚ñº</span>
                    </div>
                    <div class="fields-content">
                        ${fieldsHtml}
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="test-btn">üß™ Test Generate</button>
                    <button class="json-btn">üìã Show Sample JSON</button>
                    <button class="delete-btn">üóëÔ∏è ‡∏•‡∏ö Template</button>
                </div>
            `;

            // Attach events
            const testBtn = card.querySelector('.test-btn');
            const jsonBtn = card.querySelector('.json-btn');
            const deleteBtn = card.querySelector('.delete-btn');
            
            testBtn.addEventListener('click', () => testGenerate(template.id, sampleData, testBtn));
            jsonBtn.addEventListener('click', () => showSampleData(template.id));
            deleteBtn.addEventListener('click', () => deleteTemplate(template.id, template.name, deleteBtn));

            return card;
        }

        function toggleFields(toggleElement) {
            const content = toggleElement.nextElementSibling;
            const icon = toggleElement.querySelector('.icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggleElement.classList.remove('expanded');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('expanded');
                toggleElement.classList.add('expanded');
                icon.textContent = '‚ñ≤';
            }
        }

        function testGenerate(templateId, sampleData, button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
            button.disabled = true;

            fetch(`/api/generate/${templateId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sampleData),
            })
                .then((response) => {
                    if (response.status === 401) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ login ‡πÉ‡∏´‡∏°‡πà');
                        return;
                    }
                    if (!response.ok) throw new Error('Generation failed');
                    return response.blob();
                })
                .then((blob) => {
                    if (!blob) return;
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${templateId}_test.docx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    button.innerHTML = '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                })
                .catch((error) => {
                    alert('Error: ' + error.message);
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
        }

        function showSampleData(templateId) {
            fetch(`/api/template/${templateId}`)
                .then((res) => {
                    if (res.status === 401) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ login ‡πÉ‡∏´‡∏°‡πà');
                        return;
                    }
                    return res.json();
                })
                .then((data) => {
                    if (data) {
                        alert('Sample JSON for ' + templateId + ':\n\n' + JSON.stringify(data.sampleData, null, 2));
                    }
                })
                .catch((error) => alert('Error: ' + error.message));
        }

        function deleteTemplate(templateId, templateName, button) {
            // Confirm deletion
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö template "${templateName}"?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
                return;
            }

            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
            button.disabled = true;

            fetch(`/api/template/${templateId}`, {
                method: 'DELETE',
            })
                .then((response) => {
                    if (response.status === 401) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ login ‡πÉ‡∏´‡∏°‡πà');
                        return;
                    }
                    if (response.status === 404) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö template ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                        return;
                    }
                    if (!response.ok) throw new Error('Delete failed');
                    return response.json();
                })
                .then((data) => {
                    if (data) {
                        button.innerHTML = '‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!';
                        setTimeout(() => {
                            // Reload templates to refresh the list
                            loadTemplates();
                        }, 1000);
                    }
                })
                .catch((error) => {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö template: ' + error.message);
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
        }

        // File input enhancement
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.querySelector('.file-input');
            const fileLabel = document.querySelector('.file-input-label');
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileLabel.innerHTML = `üìÑ ${this.files[0].name}`;
                    fileLabel.style.color = 'var(--success-color)';
                    fileLabel.style.borderColor = 'var(--success-color)';
                } else {
                    fileLabel.innerHTML = 'üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå DOCX Template';
                    fileLabel.style.color = 'var(--text-light)';
                    fileLabel.style.borderColor = 'var(--border-light)';
                }
            });

            // Initial load
            loadTemplates();
        });
    </script>
</body>
</html> 